<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Perfume Heaven</title>
    <link rel="icon" href="https://i.postimg.cc/cCKd21YV/FB-IMG-1751915283498-prev-ui.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1B4332; --secondary-color: #6c757d; --success-color: #2a9d8f;
            --danger-color: #e76f51; --warning-color: #fca311; --background-color: #f8f9fa;
            --font-color: #212529; --card-bg: #ffffff; --border-color: #e9ecef;
            --font-family-bn: 'Hind Siliguri', sans-serif; --font-family-en: 'Poppins', sans-serif;
            --shadow-md: 0 6px 20px rgba(0,0,0,0.07); --border-radius: 16px;
        }
        body {
            font-family: var(--font-family-bn), var(--font-family-en);
            background-color: var(--background-color); margin: 0; color: var(--font-color);
        }
        .container { max-width: 800px; margin: 30px auto 50px auto; padding: 0 15px; }

        .card, .form-container {
            background: var(--card-bg); padding: 30px 40px; border-radius: var(--border-radius); box-shadow: var(--shadow-md);
        }
        .card-header h2 {
             font-size: 1.8rem; text-align: center; margin: 0 0 25px 0; color: var(--primary-color);
        }
        
        /* নতুন আপডেট: ভ্যারিয়েন্ট সিলেক্ট করার ড্রপডাউন স্টাইল */
        .variant-select-wrapper { margin-top: 8px; }
        .variant-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            font-family: var(--font-family-bn);
            font-size: 0.9rem;
            cursor: pointer;
        }
        .variant-select:focus { outline-color: var(--primary-color); }

        .review-cart-item { display: flex; gap: 15px; align-items: flex-start; padding: 15px 0; }
        .review-cart-item img { width: 60px; height: 60px; border-radius: 8px; flex-shrink: 0; }
        .review-cart-item-info { flex-grow: 1; }
        .review-cart-item-info .title { font-weight: 600; margin: 0; }
        .review-cart-item-info .qty { font-size: 0.9em; color: var(--secondary-color); margin: 2px 0; }
        .review-cart-item-price { margin-left: auto; font-weight: 600; text-align: right; white-space: nowrap; }

        #summary-cart-items .review-cart-item { border-bottom: 1px solid var(--border-color); }
        #summary-cart-items .review-cart-item:last-child { border-bottom: none; }
        
        .summary-totals-box { margin-top: 25px; border-top: 2px solid var(--border-color); padding-top: 20px; }
        .totals-summary p, .summary-totals-box p { display: flex; justify-content: space-between; font-size: 16px; margin: 10px 0; }
        .totals-summary .grand-total, .summary-totals-box .grand-total { font-weight: bold; font-size: 20px; border-top: 2px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
        #proceed-to-form-btn { width: 100%; margin-top: 25px; }

        /* Step Indicator & Form Styles (Unchanged from previous version) */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; } .step { text-align: center; flex: 1; position: relative; z-index: 2; } .step-icon { width: 36px; height: 36px; border-radius: 50%; background-color: #e9ecef; border: 2px solid var(--border-color); display: inline-flex; justify-content: center; align-items: center; font-weight: 600; color: var(--secondary-color); transition: all 0.4s ease; } .step-label { margin-top: 10px; font-size: 1rem; font-weight: 500; color: var(--secondary-color); } .step.active .step-icon, .step.finish .step-icon { background-color: var(--primary-color); color: white; border-color: var(--primary-color); } .step.active .step-label, .step.finish .step-label { color: var(--primary-color); } .step-indicator::before { content: ''; position: absolute; top: 18px; left: 10%; right: 10%; height: 3px; background-color: var(--border-color); z-index: 1; } #progress-bar { position: absolute; top: 18px; left: 10%; height: 3px; background-color: var(--primary-color); z-index: 1; width: 0%; transition: width 0.4s ease; }
        .form-step { display: none; } .form-step.active { display: block; animation: fadeIn 0.5s; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .form-step h4 { font-size: 1.6rem; text-align: center; margin-bottom: 30px; color: var(--primary-color); } .form-group { display: flex; flex-direction: column; margin-bottom: 20px; } .form-group label { margin-bottom: 8px; font-weight: 600; } .form-group input, .form-group select { width: 100%; padding: 14px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background-color: #fdfdfd; } .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(27, 67, 50, 0.15); }
        .payment-option-selector .option { padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all .3s; } .payment-option-selector .option.active { border-color: var(--primary-color); background-color: #f0f8f5; } .payment-module { margin-top: 20px; border: 1px dashed var(--border-color); padding: 20px; border-radius: 8px; } .payment-methods { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; } .payment-method { padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; } .payment-method.active { border-color: var(--primary-color); } .payment-method img { height: 40px; } .payment-instructions { background-color: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; } .payment-number-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; } .payment-instructions strong { font-size: 20px; color: var(--primary-color); } .copy-btn { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        .order-review-summary { margin-bottom: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; } .order-review-summary h5 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); } .review-info-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .form-navigation-btns { display: flex; justify-content: space-between; margin-top: 40px; gap: 20px; } .btn { padding: 14px 30px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; border-radius: 8px; flex-grow: 1; text-decoration: none; display: inline-block; text-align: center;} .btn-primary { background-color: var(--primary-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-prev { visibility: hidden; } .btn:disabled { background-color: #ced4da; cursor: not-allowed; }
        #order-success-message, #empty-cart-message { display: none; text-align: center; padding: 50px; } .btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        #checkout-container { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="checkout-container">
            <!-- Part 1: Order Summary View -->
            <div id="order-summary-view" class="card">
                <div class="card-header"><h2>আপনার কার্ট রিভিউ করুন</h2></div>
                <div id="summary-cart-items"></div>
                <div class="summary-totals-box">
                    <p><span>সাবটোটাল</span><span id="summary-subtotal-view"></span></p>
                    <p><span>ডেলিভারি চার্জ</span><span id="summary-delivery-view"></span></p>
                    <p class="grand-total"><span>মোট</span><span id="summary-total-view"></span></p>
                </div>
                <button id="proceed-to-form-btn" class="btn btn-primary">অর্ডার করতে এগিয়ে যান</button>
            </div>

            <!-- Part 2: Multi-Step Form View -->
            <div id="checkout-form-view" style="display: none;">
                <div class="form-container">
                    <form id="multi-step-checkout-form" novalidate>
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                             <div id="progress-bar"></div>
                            <div class="step active" data-step="1"><div class="step-icon">১</div><div class="step-label">ডেলিভারি</div></div>
                            <div class="step" data-step="2"><div class="step-icon">২</div><div class="step-label">পেমেন্ট</div></div>
                            <div class="step" data-step="3"><div class="step-icon">৩</div><div class="step-label">রিভিউ</div></div>
                        </div>
                        
                        <!-- Step 1: Delivery -->
                        <div class="form-step active" id="step-1">
                            <h4>ডেলিভারি তথ্য</h4>
                            <div class="form-group"><label for="customer-name">সম্পূর্ণ নাম</label><input type="text" id="customer-name" required></div>
                            <div class="form-group"><label for="customer-phone">মোবাইল নম্বর</label><input type="tel" id="customer-phone" required></div>
                            <div class="form-group"><label for="customer-address">সম্পূর্ণ ঠিকানা</label><input type="text" id="customer-address" required></div>
                            <div class="form-group"><label for="customer-division">বিভাগ</label><select id="customer-division" required></select></div>
                        </div>

                        <!-- Step 2: Payment -->
                        <div class="form-step" id="step-2">
                             <h4>পেমেন্ট অপশন</h4>
                            <div class="payment-option-selector">
                                <div class="option active" data-type="advance"><label><input type="radio" name="paymentOption" value="advance" checked> <span class="option-title">অ্যাডভান্স পেমেন্ট</span><p>অর্ডার কনফার্ম করতে শুধু ডেলিভারি চার্জ <strong>৳ 80</strong> পেমেন্ট করুন।</p></label></div>
                                <div class="option" data-type="full"><label><input type="radio" name="paymentOption" value="full"> <span class="option-title">সম্পূর্ণ পেমেন্ট</span><p>মোট <strong id="full-payment-amount-label"></strong> এখনই পেমেন্ট করুন।</p></label></div>
                            </div>
                            <div class="payment-module">
                                <div class="payment-methods">
                                    <div class="payment-method active" data-method="Bkash"><img src="https://freelogopng.com/images/all_img/1656227518bkash-logo-png.png" alt="bKash"></div>
                                    <div class="payment-method" data-method="Nagad"><img src="https://freepnglogo.com/images/all_img/1725618764nagad-horizontal-logo-png.png" alt="Nagad"></div>
                                </div>
                                <div id="payment-instructions" class="payment-instructions"></div>
                                <div class="form-group"><label for="transaction-id">Transaction ID (TrxID)</label><input type="text" id="transaction-id" required></div>
                            </div>
                        </div>

                        <!-- Step 3: Review -->
                        <div class="form-step" id="step-3">
                             <h4>আপনার অর্ডার রিভিউ করুন</h4>
                            <div class="order-review-summary"><h5>আপনার কার্ট</h5><div id="review-cart-items"></div></div>
                            <div class="order-review-summary">
                                <h5>ডেলিভারি ও পেমেন্ট তথ্য</h5>
                                <div class="review-info-item"><span>নাম:</span> <span id="review-name"></span></div>
                                <div class="review-info-item"><span>ফোন:</span> <span id="review-phone"></span></div>
                                <div class="review-info-item"><span>ঠিকানা:</span> <span id="review-address"></span></div>
                                <div class="review-info-item"><span>পেমেন্ট ধরন:</span> <span id="review-payment-type"></span></div>
                                <div class="review-info-item"><span>পেমেন্ট মাধ্যম:</span> <span id="review-payment-method"></span></div>
                            </div>
                            <div class="totals-summary">
                                <p><span>সাবটোটাল:</span> <span id="summary-subtotal"></span></p>
                                <p><span>ডেলিভারি চার্জ:</span> <span id="summary-delivery"></span></p>
                                <p class="grand-total"><span>মোট:</span> <span id="summary-total"></span></p>
                                <p><strong><span>এখন পেমেন্ট করেছেন:</span> <span id="summary-paid-now"></span></strong></p>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="form-navigation-btns">
                            <button type="button" class="btn btn-secondary btn-prev" onclick="nextPrev(-1)">আগের ধাপ</button>
                            <button type="button" class="btn btn-primary btn-next" onclick="nextPrev(1)">পরবর্তী ধাপ</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success & Empty Cart Messages -->
            <div id="order-success-message" style="display: none;">
                 <h2>ধন্যবাদ!</h2><p>আপনার অর্ডারটি সফলভাবে সম্পন্ন হয়েছে।</p>
                <div class="btn-group">
                    <a href="orders.html" class="btn btn-primary">আমার অর্ডার দেখুন</a>
                    <a href="index.html" class="btn btn-secondary">শপিং চালিয়ে যান</a>
                </div>
            </div>
            <div id="empty-cart-message" style="display: none;">
                 <h3>আপনার কার্ট খালি।</h3><p>অর্ডার করার জন্য প্রথমে পণ্য কার্টে যোগ করুন।</p>
                <div class="btn-group"><a href="index.html" class="btn btn-primary">শপিং-এ ফিরে যান</a></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY",
            authDomain: "movie-92659.firebaseapp.com",
            databaseURL: "https://movie-92659-default-rtdb.firebaseio.com",
            projectId: "movie-92659",
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null, cart = [], currentStep = 1;
        const TOTAL_STEPS = 3, DELIVERY_CHARGE = 80;
        const PAYMENT_NUMBERS = { Bkash: "01798796479", Nagad: "01798796479" };
        const bdDivisions = ["ঢাকা", "চট্টগ্রাম", "খুলনা", "রাজশাহী", "বরিশাল", "সিলেট", "রংপুর", "ময়মনসিংহ"];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('checkout-container').style.display = 'block';
            document.getElementById('customer-division').innerHTML = bdDivisions.map(d => `<option value="${d}">${d}</option>`).join('');

            onAuthStateChanged(auth, user => {
                if (user) { currentUser = user; loadCartAndInitialize(); } 
                else { alert("অর্ডার করার জন্য অনুগ্রহ করে লগইন করুন।"); window.location.href = 'account.html'; }
            });
        });

        function loadCartAndInitialize() {
            const localCart = localStorage.getItem('shoppingCart');
            cart = localCart ? JSON.parse(localCart) : [];
            
            if (cart.length === 0) {
                document.getElementById('empty-cart-message').style.display = 'block';
                return;
            }

            // নতুন আপডেট: কার্টের প্রতিটি আইটেমের জন্য সিলেক্টেড ভ্যারিয়েন্ট ট্র্যাক করা
            cart.forEach(item => {
                if (item.variants && Object.keys(item.variants).length > 0) {
                    item.selectedVariantKey = Object.keys(item.variants)[0];
                }
            });
            
            document.getElementById('order-summary-view').style.display = 'block';
            renderInitialSummary();
            setupEventListeners();
        }
        
        // নতুন ফাংশন: প্রাথমিক সামারি রেন্ডার করা
        function renderInitialSummary() {
            const itemsContainer = document.getElementById('summary-cart-items');
            itemsContainer.innerHTML = '';
            cart.forEach(item => {
                itemsContainer.innerHTML += createCartItemHTML(item, true); // true মানে ড্রপডাউন সহ
            });
            recalculateAndRenderTotals();
        }

        function handleVariantChange(itemId, newVariantKey) {
            const item = cart.find(i => i.id === itemId);
            if (item) {
                item.selectedVariantKey = newVariantKey;
                // একটি আইটেমের মূল্য তাৎক্ষণিকভাবে আপডেট করুন
                const priceElement = document.getElementById(`price-${itemId}`);
                if(priceElement) {
                    const newPrice = item.variants[newVariantKey].price;
                    priceElement.textContent = `৳${(newPrice * item.quantity).toFixed(2)}`;
                }
                recalculateAndRenderTotals();
            }
        }

        // নতুন ফাংশন: টোটাল পুনঃগণনা এবং UI আপডেট
        function recalculateAndRenderTotals() {
            let subtotal = 0;
            cart.forEach(item => {
                let price;
                if (item.variants && item.selectedVariantKey) {
                    price = item.variants[item.selectedVariantKey].price;
                } else {
                    price = item.price;
                }
                subtotal += price * item.quantity;
            });
            const totalAmount = subtotal + DELIVERY_CHARGE;

            // প্রাথমিক সামারি ভিউ আপডেট
            document.getElementById('summary-subtotal-view').textContent = `৳ ${subtotal.toFixed(2)}`;
            document.getElementById('summary-delivery-view').textContent = `৳ ${DELIVERY_CHARGE.toFixed(2)}`;
            document.getElementById('summary-total-view').textContent = `৳ ${totalAmount.toFixed(2)}`;
            
            // পেমেন্ট ফর্ম আপডেট
            document.getElementById('full-payment-amount-label').textContent = `(৳ ${totalAmount.toFixed(2)})`;
            updatePriceAndPaymentUI();
        }

        function updatePriceAndPaymentUI() {
            let subtotal = 0;
            cart.forEach(item => {
                const price = item.selectedVariantKey ? item.variants[item.selectedVariantKey].price : item.price;
                subtotal += price * item.quantity;
            });
            const totalAmount = subtotal + DELIVERY_CHARGE;
            
            const paymentType = document.querySelector('input[name="paymentOption"]:checked').value;
            const amountToPay = paymentType === 'full' ? totalAmount : DELIVERY_CHARGE;
            const activeMethod = document.querySelector('.payment-method.active').dataset.method;
            const number = PAYMENT_NUMBERS[activeMethod];

            const instructionsEl = document.getElementById('payment-instructions');
            instructionsEl.innerHTML = `<p>এই ${activeMethod} নম্বরে <strong>৳ ${amountToPay.toFixed(2)}</strong> সেন্ড মানি করুন:</p><div class="payment-number-wrapper"><strong>${number}</strong><button type="button" class="copy-btn">কপি</button></div>`;
            instructionsEl.querySelector('.copy-btn').onclick = () => navigator.clipboard.writeText(number).then(() => alert('নম্বর কপি হয়েছে!'));
        }

        window.nextPrev = (n) => {
            if (n > 0 && !validateStep(currentStep)) return;
            currentStep += n;
            if (currentStep > TOTAL_STEPS) { handleOrderSubmit(); return; }
            if (currentStep === TOTAL_STEPS) { populateReviewStep(); }
            showStep(currentStep);
        };
        
        function showStep(step) { /* This function remains unchanged */
            document.querySelectorAll('.form-step').forEach(s => s.style.display = 'none');
            document.getElementById(`step-${step}`).style.display = 'block';
            document.querySelector('.btn-prev').style.visibility = step === 1 ? 'hidden' : 'visible';
            const nextBtn = document.querySelector('.btn-next');
            nextBtn.textContent = (step === TOTAL_STEPS) ? 'অর্ডার কনফার্ম করুন' : 'পরবর্তী ধাপ';
            updateStepIndicator();
        }

        function updateStepIndicator() { /* This function remains unchanged */
             document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'finish');
                if (i + 1 < currentStep) s.classList.add('finish');
                else if (i + 1 === currentStep) s.classList.add('active');
            });
            document.getElementById('progress-bar').style.width = `${((currentStep - 1) / (TOTAL_STEPS - 1)) * 80}%`;
        }
        
        function validateStep(step) { /* This function remains unchanged */
            let isValid = true;
            document.querySelectorAll(`#step-${step} [required]`).forEach(i => {
                if (!i.value.trim()) { i.style.borderColor = 'red'; isValid = false; }
                else { i.style.borderColor = 'var(--border-color)'; }
            });
            if (!isValid) alert('দয়া করে প্রয়োজনীয় সব তথ্য দিন।');
            return isValid;
        }

        function populateReviewStep() {
            document.getElementById('review-name').textContent = document.getElementById('customer-name').value;
            document.getElementById('review-phone').textContent = document.getElementById('customer-phone').value;
            document.getElementById('review-address').textContent = `${document.getElementById('customer-address').value}, ${document.getElementById('customer-division').value}`;
            
            const paymentType = document.querySelector('input[name="paymentOption"]:checked').value;
            const activeMethod = document.querySelector('.payment-method.active').dataset.method;
            document.getElementById('review-payment-type').textContent = paymentType === 'full' ? 'সম্পূর্ণ পেমেন্ট' : 'অ্যাডভান্স';
            document.getElementById('review-payment-method').textContent = `${activeMethod} (TrxID: ${document.getElementById('transaction-id').value})`;

            const reviewItemsContainer = document.getElementById('review-cart-items');
            reviewItemsContainer.innerHTML = '';
            let subtotal = 0;
            cart.forEach(item => {
                reviewItemsContainer.innerHTML += createCartItemHTML(item, false); // false মানে ড্রপডাউন ছাড়া
                const price = item.selectedVariantKey ? item.variants[item.selectedVariantKey].price : item.price;
                subtotal += price * item.quantity;
            });
            
            const totalAmount = subtotal + DELIVERY_CHARGE;
            const amountPaidNow = paymentType === 'full' ? totalAmount : DELIVERY_CHARGE;
            document.getElementById('summary-subtotal').textContent = `৳ ${subtotal.toFixed(2)}`;
            document.getElementById('summary-delivery').textContent = `৳ ${DELIVERY_CHARGE.toFixed(2)}`;
            document.getElementById('summary-total').textContent = `৳ ${totalAmount.toFixed(2)}`;
            document.getElementById('summary-paid-now').textContent = `৳ ${amountPaidNow.toFixed(2)}`;
        }

        function createCartItemHTML(item, withDropdown) {
            let price, variantName, variantHTML = '';
            if (item.variants && item.selectedVariantKey) {
                const selectedVariant = item.variants[item.selectedVariantKey];
                price = selectedVariant.price;
                variantName = selectedVariant.name;
                
                if (withDropdown) {
                    const options = Object.keys(item.variants).map(key => {
                        const variant = item.variants[key];
                        return `<option value="${key}" ${key === item.selectedVariantKey ? 'selected' : ''}>${variant.name} - ৳${variant.price}</option>`;
                    }).join('');
                    variantHTML = `<div class="variant-select-wrapper"><select class="variant-select" data-item-id="${item.id}" onchange="handleVariantChange('${item.id}', this.value)">${options}</select></div>`;
                }
            } else {
                price = item.price;
                variantName = 'Standard';
            }

            const itemTotal = price * item.quantity;
            return `
                <div class="review-cart-item">
                    <img src="${item.imageUrl}" alt="${item.title}">
                    <div class="review-cart-item-info">
                        <p class="title">${item.title}</p>
                        <p class="qty">${item.quantity} x ${variantName}</p>
                        ${variantHTML}
                    </div>
                    <span class="review-cart-item-price" id="price-${item.id}">৳${itemTotal.toFixed(2)}</span>
                </div>
            `;
        }
        
        async function handleOrderSubmit() {
            const confirmBtn = document.querySelector('.btn-next');
            confirmBtn.disabled = true; confirmBtn.textContent = 'প্রসেসিং...';
            
            let subtotal = 0;
            const orderItems = cart.map(item => {
                const selectedVariant = item.selectedVariantKey ? item.variants[item.selectedVariantKey] : { name: 'Standard', price: item.price };
                subtotal += selectedVariant.price * item.quantity;
                return { id: item.id, title: item.title, quantity: item.quantity, imageUrl: item.imageUrl, variant: selectedVariant };
            });

            const totalAmount = subtotal + DELIVERY_CHARGE;
            const paymentType = document.querySelector('input[name="paymentOption"]:checked').value;
            const amountPaid = paymentType === 'full' ? totalAmount : DELIVERY_CHARGE;

            const orderData = {
                userId: currentUser.uid,
                customerInfo: { name: document.getElementById('customer-name').value, phone: document.getElementById('customer-phone').value, address: document.getElementById('customer-address').value, division: document.getElementById('customer-division').value },
                paymentInfo: { type: paymentType, method: document.querySelector('.payment-method.active').dataset.method, transactionId: document.getElementById('transaction-id').value, amountPaid: amountPaid },
                items: orderItems, subtotal: subtotal, shippingCost: DELIVERY_CHARGE, totalAmount: totalAmount,
                orderDate: new Date().toISOString(), status: 'Pending'
            };

            try {
                await set(push(ref(db, 'orders')), orderData);
                localStorage.removeItem('shoppingCart');
                document.getElementById('checkout-form-view').style.display = 'none';
                document.getElementById('order-success-message').style.display = 'block';
            } catch (error) {
                alert('অর্ডার করা যায়নি। আবার চেষ্টা করুন।');
                confirmBtn.disabled = false; confirmBtn.textContent = 'অর্ডার কনফার্ম করুন';
            }
        }

        function setupEventListeners() {
            window.handleVariantChange = handleVariantChange; // Make it globally accessible for onchange
            
            document.getElementById('proceed-to-form-btn').addEventListener('click', () => {
                document.getElementById('order-summary-view').style.display = 'none';
                document.getElementById('checkout-form-view').style.display = 'block';
                window.scrollTo(0, 0);
            });
            
            document.querySelector('.payment-option-selector').addEventListener('click', (e) => {
                if (e.target.closest('.option')) {
                    document.querySelectorAll('.payment-option-selector .option').forEach(opt => opt.classList.remove('active'));
                    const targetOption = e.target.closest('.option');
                    targetOption.classList.add('active');
                    targetOption.querySelector('input[type="radio"]').checked = true;
                    updatePriceAndPaymentUI();
                }
            });
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                    method.classList.add('active');
                    updatePriceAndPaymentUI();
                });
            });
        }
    </script>
</body>
</html>